# D-connection-checker

[![NPM Version][npm-image]][npm-url]
[![License][license-image]][license-url]

Библиотека для проверки подключения к удаленному сервису по IP-адресу и порту

# Установка NPM

```sh
npm i @dlabs71/d-connection-checker
```

# Использование

Данная библиотека может быть использована в любом Node.js или Electron приложении. Для корректной работы библиотеки
необходим модуль Node.js - [net](https://nodejs.org/api/net.html).

D-connection-checker предоставляет класс с возможностью хранения данных о множестве подключений (IP и порт) и набором
методов для проверки доступности данных подключений. Также библиотека предоставляет класс для организации циклической
проверки доступности, хранимых подключений.

**`example-1.js`**

```js
import {CheckerConnection, HostData} from '@dlabs71/d-connection-checker';

let host = HostData.build("ya.ru", 80);

let checkerConnection = new CheckerConnection();
checkerConnection.checkConnectionByHost(host)
        .then(() => {
            // сервис доступен
        })
        .catch((err) => {
            // сервис не доступен.
            // при недоступности сервиса метод проверяет коннекшен ещё 4 раза (по умолчанию), 
            // каждый раз уменьшая timeout в двое. Если все разы сервис так и не стал доступен, 
            // то считается что подключение недоступно. Данное поведение также можно изменить при помощи 
            // доп. параметров метода или параметров конструктора
        });
```

**`example-2.js`**

```js
import {CheckerConnectionRunner, HostData} from '@dlabs71/d-connection-checker';

let hosts = [
    HostData.build("ya.ru", 80),
    HostData.build("localhost", 2222)
];

let rejectFunc = (host) => {
    // когда сервис становиться неактивным, вызывается эта функция
};

let checker = new CheckerConnectionRunner(rejectFunc);
checker.setHosts(hosts);
checker.run();
// runner запущен, теперь в цикле будут проверяться все сервисы хранимые в нём. Если сервис недоступен, 
// то у него проставляется статус ERROR и он больше не проверяется, пока статус не измениться вручную

// чтобы остановить цикличную проверку необходимо вызвать метод stop
checker.stop();
```

# Документация

## Оглавление

* [1. Класс HostData](#section1)
* [2. Класс CheckerConnection](#section2)
    * [2.1. Метод checkConnectionByHost](#section21)
    * [2.2. Метод checkConnectionById](#section22)
    * [2.3. Метод checkConnections](#section23)
    * [2.4. Метод setHosts](#section24)
    * [2.5. Метод addHost](#section25)
    * [2.6. Метод removeHost](#section26)
    * [2.7. Метод getHosts](#section27)
* [3. Класс CheckerConnectionRunner](#section3)
    * [3.1. Метод run](#section31)
    * [3.2. Метод stop](#section32)

## <h2 id="section1">1. Класс HostData</h2>

Класс **HostData** предназначен для описания параметров сервиса IP, порт и служебных параметров, таких как ID и статуса
доступности при последней проверке. Это основной класс через который происходит передача данных в функциональные методы
данной библиотеки.

| **Поле**   | **Тип**    | **Значение по умолчанию**  | **Описание**     |
| :----------| :----------| :------------------------- | :----------------|
| $id        | String     |                            | Уникальный идентификатор объекта. Создаётся на основе host и port |
| $status    | String     | READY                      | Статус последней проверки подключения SUCCESS или ERROR |
| host       | String     |                            | IP адрес сервиса |
| port       | Number     |                            | порт сервиса |
| addedData  | Object     | {}                         | Дополнительные данные. Устанавливаются пользователем при необходимости |

Данный класс имеет статический метод **build**, предназначенный для быстрого и удобного создания экземпляра класса.
Принимает 2 параметра:

| **Параметр** | **Тип** | **Обязательность** | **Значение по умолчанию** | **Описание**     |
| :------------| :-------| :----------------- | :------------------------ | :----------------|
| host         | String  | да                 |                           | IP адрес сервиса |
| port         | Number  | да                 |                           | порт сервиса     |
| addedData    | Number  | нет                | {}                        | Дополнительные данные     |

Пример использования:

```js
import {HostData} from '@dlabs71/d-connection-checker';

let hostData1 = new HostData("localhost", 2222);

let hostData2 = HostData.build("ya.ru", 80);

let hostData3 = HostData.build("ya.ru", 80, {outerId: 123, name: "Yandex"});
```

## <h2 id="section2">2. Класс CheckerConnection</h2>

Класс **CheckerConnection** предназначен для хранения подключений, а также проверки их доступности. Конструктор данного
класса принимает следующие параметры:

| **Параметр**       | **Тип**    | **Обязательность** | **Значение по умолчанию** | **Описание**     |
| :----------------- | :----------| :----------------- | :------------------------ | :----------------|
| logger             | Console    | нет                | console                   | Логгер |
| defaultRepeat      | Number     | нет                | 3                         | Количество повторений проверки доступности |
| pingDefaultTimeout | Number     | нет                | 8000                      | timeout ожидания подключения |

### <h3 id="section21">2.1. Метод checkConnectionByHost</h3>

Метод **checkConnectionByHost** предназначен для проверки доступности сервиса по IP и порту. При отсутствии подключения
данный метод пытается ещё несколько раз подключиться, каждый раз уменьшая timeout подключения в двое. Если подключение
всё равно остаётся недоступным, то считается что подключение полностью недоступно. Данное поведение можно регулировать
при помощи параметров repeat и timeout. Параметры:

| **Параметр** | **Тип**    | **Обязательность** | **Значение по умолчанию**                      | **Описание**      |
| :----------- | :----------| :----------------- | :--------------------------------------------- | :---------------- |
| hostData     | HostData   | да                 |                                                | Информация о сервисе |
| repeat       | Number     | нет                | 3 (используется глобальный параметр класса)    | Количество повторений проверки доступности |
| timeout      | Number     | нет                | 8000 (используется глобальный параметр класса) | timeout ожидания подключения |

Пример использования:

```js
import {HostData, CheckerConnection} from '@dlabs71/d-connection-checker';

let host = HostData.build("ya.ru", 80);
let checkerConnection = new CheckerConnection();

checkerConnection.checkConnectionByHost(host)
        .then(() => {
            console.log("CONNECTION SUCCESS");
        })
        .catch((err) => {
            console.log("CONNECTION REFUSE");
        });
```

### <h3 id="section22">2.2. Метод checkConnectionById</h3>

Метод **checkConnectionById** предназначен для проверки доступности сервиса по ID хранимого подключения во встроенном
хранилище. Параметры:

| **Параметр** | **Тип**    | **Обязательность** | **Значение по умолчанию**                      | **Описание**      |
| :----------- | :----------| :----------------- | :--------------------------------------------- | :---------------- |
| storeId      | String     | да                 |                                                | ID подключения в хранилище (параметр $id в HostData) |
| repeat       | Number     | нет                | 3 (используется глобальный параметр класса)    | Количество повторений проверки доступности |
| timeout      | Number     | нет                | 8000 (используется глобальный параметр класса) | timeout ожидания подключения |

Пример использования:

```js
import {HostData, CheckerConnection} from '@dlabs71/d-connection-checker';

let hosts = [
    HostData.build("ya.ru", 80),
    HostData.build("localhost", 2222),
];
let checkerConnection = new CheckerConnection();
checkerConnection.setHosts(hosts);

checkerConnection.checkConnectionById(hosts[0].$id)
        .then(() => {
            console.log("CONNECTION SUCCESS");
        })
        .catch((err) => {
            console.log("CONNECTION REFUSE");
        });
```

### <h3 id="section23">2.3. Метод checkConnections</h3>

Метод **checkConnections** предназначен для проверки доступности сервисов, которые хранятся в хранилище. Параметры:

| **Параметр** | **Тип**    | **Обязательность** | **Значение по умолчанию**                      | **Описание**      |
| :----------- | :----------| :----------------- | :--------------------------------------------- | :---------------- |
| rejectFunc   | Function   | нет                | (host)=>{}                                     | Callback функция, которая будет вызываться когда проверяемое подключение будет недоступным |

Пример использования:

```js
import {HostData, CheckerConnection} from '@dlabs71/d-connection-checker';

let hosts = [
    HostData.build("ya.ru", 80),
    HostData.build("localhost", 2222),
];
let rejectFunc = (host) => {
    // когда сервис становиться неактивным, вызывается эта функция
};

let checkerConnection = new CheckerConnection();
checkerConnection.setHosts(hosts);

checkerConnection.checkConnections(rejectFunc)
        .finally(() => {
        });
```

### <h3 id="section24">2.4. Метод setHosts</h3>

Метод **setHosts** предназначен для того, чтобы инициализировать хранилище списком подключений описанных при помощи
класса **HostData**. Параметры:

| **Параметр** | **Тип**    | **Обязательность** | **Значение по умолчанию** | **Описание**       |
| :----------- | :----------| :----------------- | :------------------------ | :----------------- |
| hosts        | HostData[] | да                 |                           | Массив подключений |

### <h3 id="section25">2.5. Метод addHost</h3>

Метод **addHost** предназначен для того, чтобы добавить в хранилище новое подключение, описанное при помощи класса **
HostData**. Параметры:

| **Параметр** | **Тип**    | **Обязательность** | **Значение по умолчанию** | **Описание**       |
| :----------- | :----------| :----------------- | :------------------------ | :----------------- |
| host         | HostData   | да                 |                           | Данные подключения |

### <h3 id="section26">2.6. Метод removeHost</h3>

Метод **removeHost** предназначен для того, чтобы удалить из хранилища подключение, описанное при помощи класса **
HostData**. Параметры:

| **Параметр** | **Тип**    | **Обязательность** | **Значение по умолчанию** | **Описание**       |
| :----------- | :----------| :----------------- | :------------------------ | :----------------- |
| host         | HostData   | да                 |                           | Данные подключения |

### <h3 id="section27">2.7. Метод getHosts</h3>

Метод **getHosts** предназначен для того, чтобы получить список всех подключений хранимых в хранилище.

Возвращаемое значение:

| **Тип**    |  **Описание**       |
| :----------|  :----------------- |
| HostData[] | Массив подключений  |

## <h2 id="section3">3. Класс CheckerConnectionRunner</h2>

Класс **CheckerConnectionRunner** предназначен для реализации цикличной проверки подключений. Наследует **
CheckerConnection**. Параметры конструктора:

| **Параметр**       | **Тип**    | **Обязательность** | **Значение по умолчанию** | **Описание**     |
| :----------------- | :----------| :----------------- | :------------------------ | :----------------|
| rejectFunc         | Function   | да                 |                           | Callback функция, которая будет вызываться когда проверяемое подключение будет недоступным |
| logger             | Console    | нет                | console                   | Логгер |
| defaultRepeat      | Number     | нет                | 3                         | Количество повторений проверки доступности |
| pingDefaultTimeout | Number     | нет                | 8000                      | timeout ожидания подключения |
| runTimeout         | Number     | нет                | 4000                      | timeout ожидания между циклами запуска проверки |

### <h3 id="section31">3.1. Метод run</h3>

Метод **run** предназначен для того, чтобы запустить циклическую проверку подключений хранимых в хранилище. Параметры:

| **Параметр** | **Тип**    | **Обязательность** | **Значение по умолчанию**                      | **Описание**       |
| :----------- | :----------| :----------------- | :--------------------------------------------- | :----------------- |
| timeout      | Number     | нет                | 4000 (используется глобальный параметр класса) | timeout ожидания между циклами запуска проверки |

### <h3 id="section32">3.2. Метод stop</h3>

Метод **stop** предназначен для того, чтобы остановить циклическую проверку подключений хранимых в хранилище.

[npm-image]: https://img.shields.io/npm/v/@dlabs71/d-connection-checker

[npm-url]: https://www.npmjs.com/package/@dlabs71/d-connection-checker

[license-image]: https://img.shields.io/badge/license-MIT-blue.svg

[license-url]: LICENSE